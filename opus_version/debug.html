<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug TCO Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 200px;
        }
        input {
            width: 100px;
            padding: 5px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }
        #debug {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .kpi-card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .kpi-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .kpi-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§Š Debug TCO Calculator</h1>
        
        <div class="inputs">
            <h3>Air Cooling</h3>
            <div class="input-group">
                <label>Number of Racks:</label>
                <input type="number" id="airRacks" value="10">
            </div>
            <div class="input-group">
                <label>Power per Rack (kW):</label>
                <input type="number" id="airPower" value="10">
            </div>
            <div class="input-group">
                <label>PUE:</label>
                <input type="number" id="airPUE" value="1.7" step="0.01">
            </div>
            
            <h3>Immersion Cooling</h3>
            <div class="input-group">
                <label>Number of Tanks:</label>
                <input type="number" id="immersionTanks" value="5">
            </div>
            <div class="input-group">
                <label>Power per Tank (kW):</label>
                <input type="number" id="immersionPower" value="20">
            </div>
            <div class="input-group">
                <label>PUE:</label>
                <input type="number" id="immersionPUE" value="1.03" step="0.01">
            </div>
            
            <h3>Financial</h3>
            <div class="input-group">
                <label>Analysis Years:</label>
                <input type="number" id="years" value="5">
            </div>
            <div class="input-group">
                <label>Electricity Price ($/kWh):</label>
                <input type="number" id="electricity" value="0.10" step="0.01">
            </div>
            
            <button onclick="calculate()">Calculate</button>
            <button onclick="showChart('bar')">Bar Chart</button>
            <button onclick="showChart('line')">Line Chart</button>
            <button onclick="showChart('doughnut')">Doughnut Chart</button>
        </div>
        
        <div class="results" id="results" style="display:none;">
            <h3>Results</h3>
            <div class="kpi-grid" id="kpiGrid"></div>
            <canvas id="myChart"></canvas>
        </div>
        
        <div id="debug">Debug Console:</div>
    </div>
    
    <script>
        let currentChart = null;
        let calculationData = null;
        
        function log(message) {
            const debug = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debug.innerHTML += `\n[${time}] ${message}`;
            debug.scrollTop = debug.scrollHeight;
            console.log(message);
        }
        
        function calculate() {
            log('Starting calculation...');
            
            try {
                // Get input values
                const params = {
                    airRacks: parseInt(document.getElementById('airRacks').value),
                    airPower: parseFloat(document.getElementById('airPower').value),
                    airPUE: parseFloat(document.getElementById('airPUE').value),
                    immersionTanks: parseInt(document.getElementById('immersionTanks').value),
                    immersionPower: parseFloat(document.getElementById('immersionPower').value),
                    immersionPUE: parseFloat(document.getElementById('immersionPUE').value),
                    years: parseInt(document.getElementById('years').value),
                    electricity: parseFloat(document.getElementById('electricity').value)
                };
                
                log('Input params: ' + JSON.stringify(params));
                
                // Calculate
                const HOURS_PER_YEAR = 8760;
                
                // Air cooling
                const airTotalPower = params.airRacks * params.airPower;
                const airPowerWithPUE = airTotalPower * params.airPUE;
                const airAnnualEnergy = airPowerWithPUE * HOURS_PER_YEAR / 1000; // MWh
                const airCapex = params.airRacks * 50000;
                const airAnnualOpex = airAnnualEnergy * params.electricity * 1000 + (airCapex * 0.05);
                const airTotalCost = airCapex + (airAnnualOpex * params.years);
                
                // Immersion cooling
                const immersionTotalPower = params.immersionTanks * params.immersionPower;
                const immersionPowerWithPUE = immersionTotalPower * params.immersionPUE;
                const immersionAnnualEnergy = immersionPowerWithPUE * HOURS_PER_YEAR / 1000; // MWh
                const immersionCapex = params.immersionTanks * 100000;
                const immersionAnnualOpex = immersionAnnualEnergy * params.electricity * 1000 + (immersionCapex * 0.03);
                const immersionTotalCost = immersionCapex + (immersionAnnualOpex * params.years);
                
                // Savings
                const totalSavings = airTotalCost - immersionTotalCost;
                const annualSavings = airAnnualOpex - immersionAnnualOpex;
                const roi = (totalSavings / immersionCapex * 100);
                const payback = immersionCapex / annualSavings;
                const energySavings = airAnnualEnergy - immersionAnnualEnergy;
                const co2Reduction = energySavings * 0.5;
                
                calculationData = {
                    air: {
                        totalCost: airTotalCost,
                        capex: airCapex,
                        opex: airAnnualOpex,
                        energy: airAnnualEnergy
                    },
                    immersion: {
                        totalCost: immersionTotalCost,
                        capex: immersionCapex,
                        opex: immersionAnnualOpex,
                        energy: immersionAnnualEnergy
                    },
                    savings: {
                        total: totalSavings,
                        annual: annualSavings,
                        roi: roi,
                        payback: payback,
                        energy: energySavings,
                        co2: co2Reduction
                    }
                };
                
                log('Calculation complete: Total Savings = $' + totalSavings.toFixed(0));
                
                // Display results
                displayResults();
                showChart('bar');
                
            } catch (error) {
                log('ERROR: ' + error.message);
                console.error(error);
            }
        }
        
        function displayResults() {
            const kpiGrid = document.getElementById('kpiGrid');
            kpiGrid.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Total Savings</div>
                    <div class="kpi-value">$${Math.round(calculationData.savings.total).toLocaleString()}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Annual Savings</div>
                    <div class="kpi-value">$${Math.round(calculationData.savings.annual).toLocaleString()}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">ROI</div>
                    <div class="kpi-value">${calculationData.savings.roi.toFixed(1)}%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Payback Period</div>
                    <div class="kpi-value">${calculationData.savings.payback.toFixed(1)} years</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Energy Savings</div>
                    <div class="kpi-value">${Math.round(calculationData.savings.energy)} MWh/yr</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">CO2 Reduction</div>
                    <div class="kpi-value">${Math.round(calculationData.savings.co2)} tons/yr</div>
                </div>
            `;
            
            document.getElementById('results').style.display = 'block';
            log('Results displayed');
        }
        
        function showChart(type) {
            if (!calculationData) {
                log('No data available for chart');
                return;
            }
            
            log('Creating ' + type + ' chart...');
            
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = document.getElementById('myChart').getContext('2d');
            
            const chartConfig = {
                type: type,
                data: {
                    labels: ['Air Cooling', 'Immersion Cooling'],
                    datasets: [{
                        label: 'Total Cost',
                        data: [calculationData.air.totalCost, calculationData.immersion.totalCost],
                        backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)'],
                        borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'TCO Comparison'
                        }
                    }
                }
            };
            
            if (type === 'line') {
                // Create timeline data
                const years = [];
                const airCosts = [];
                const immersionCosts = [];
                
                for (let i = 0; i <= 5; i++) {
                    years.push('Year ' + i);
                    airCosts.push(calculationData.air.capex + (calculationData.air.opex * i));
                    immersionCosts.push(calculationData.immersion.capex + (calculationData.immersion.opex * i));
                }
                
                chartConfig.data = {
                    labels: years,
                    datasets: [{
                        label: 'Air Cooling',
                        data: airCosts,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Immersion Cooling',
                        data: immersionCosts,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }]
                };
            }
            
            if (type === 'doughnut') {
                chartConfig.data = {
                    labels: ['Air CAPEX', 'Air OPEX', 'Immersion CAPEX', 'Immersion OPEX'],
                    datasets: [{
                        data: [
                            calculationData.air.capex,
                            calculationData.air.opex * 5,
                            calculationData.immersion.capex,
                            calculationData.immersion.opex * 5
                        ],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 99, 132, 0.4)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(54, 162, 235, 0.4)'
                        ]
                    }]
                };
            }
            
            try {
                currentChart = new Chart(ctx, chartConfig);
                log('Chart created successfully');
            } catch (error) {
                log('Chart error: ' + error.message);
            }
        }
        
        // Test on load
        window.onload = function() {
            log('Page loaded successfully');
            log('Chart.js version: ' + (typeof Chart !== 'undefined' ? Chart.version : 'NOT LOADED'));
        };
    </script>
</body>
</html>